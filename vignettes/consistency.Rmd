---
title: "Consistency of MLBAM data"
author: "Ben Baumer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


Here are a few useful sanity checks for the data compiled by the `openWAR` package. 

```{r, eval=FALSE}
library(openWAR)
library(mosaic)
data(MLBAM2013)
ds = MLBAM2013
```

#### Data Accuracy

First, some basic accounting to make sure that our data is accurate. Compare these with [Baseball-reference.com](http://www.baseball-reference.com/leagues/MLB/2013-standard-batting.shtml)


```{r, eval=FALSE}
sort(tally(~event, data = ds), decreasing = TRUE)
```

```
## 
##                    Total                Strikeout                Groundout 
##                   107774                    21161                    20678 
##                   Single                   Flyout                     Walk 
##                    16417                    13773                     7837 
##                  Pop Out                  Lineout                   Double 
##                     5144                     5112                     4838 
##                 Home Run                 Forceout         Grounded Into DP 
##                     2804                     2276                     2164 
##             Hit By Pitch              Field Error                 Sac Bunt 
##                      910                      879                      806 
##                  Sac Fly              Intent Walk                   Triple 
##                      731                      598                      459 
##              Double Play           Bunt Groundout               Runner Out 
##                      267                      217                      216 
##      Fielders Choice Out             Bunt Pop Out           Strikeout - DP 
##                      196                       83                       80 
##          Fielders Choice         Fan interference      Batter Interference 
##                       51                       25                       21 
##     Catcher Interference               Sac Fly DP             Bunt Lineout 
##                       15                        8                        6 
##              Triple Play        Sacrifice Bunt DP       Caught Stealing 2B 
##                        1                        1                        0 
##         Defensive Indiff         Defensive Switch            Game Advisory 
##                        0                        0                        0 
##            Offensive sub    Pitching Substitution            Defensive Sub 
##                        0                        0                        0 
##                    Error           Player Injured               Wild Pitch 
##                        0                        0                        0 
##           Stolen Base 2B   Picked off stealing 2B       Caught Stealing 3B 
##                        0                        0                        0 
##              Passed Ball               Pickoff 1B                     Balk 
##                        0                        0                        0 
##           Stolen Base 3B   Picked off stealing 3B                 Ejection 
##                        0                        0                        0 
##               Pickoff 3B              Batter Turn         Pickoff Error 1B 
##                        0                        0                        0 
##         Pickoff Error 2B              Pickoff 2B          Pickoff Error 3B 
##                        0                        0                        0 
##     Caught Stealing Home           Runner Advance      Umpire Substitution 
##                        0                        0                        0 
## Picked off stealing home 
##                        0
```

```{r, eval=FALSE}
ds$bat_team = with(ds, ifelse(half == "top", as.character(away_team), as.character(home_team)))
teams = ddply(ds, ~bat_team, summarise, G = length(unique(gameId)), PA = sum(isPA), 
    R = sum(runsOnPlay), H = sum(isHit), HR = sum(event == "Home Run"), K = sum(event %in% 
        c("Strikeout", "Strikeout - DP")), OBP = sum(isHit | event %in% c("Walk", 
        "Intent Walk", "Hit By Pitch"))/sum(isPA & !event %in% c("Sac Bunt", 
        "Sacrifice Bunt DP")))
teams[order(teams$OBP, decreasing = TRUE), ]
```

```
##    bat_team  G   PA   R   H  HR   K    OBP
## 5       bos 97 3812 498 934  98 786 0.3496
## 11      det 94 3740 477 936 106 648 0.3482
## 26      sln 93 3564 464 885  82 627 0.3380
## 27      tba 96 3666 449 850 106 669 0.3303
## 9       cle 95 3613 454 825 104 782 0.3302
## 1       ana 93 3603 430 862 102 655 0.3298
## 8       cin 95 3708 414 812  92 737 0.3276
## 14      lan 94 3537 359 825  75 641 0.3242
## 3       atl 95 3621 415 801 114 826 0.3238
## 10      col 96 3683 426 880 108 731 0.3228
## 20      oak 95 3660 430 795  98 715 0.3222
## 28      tex 95 3596 411 844 112 621 0.3208
## 25      sfn 94 3599 380 851  62 626 0.3178
## 2       ari 95 3673 399 841  80 679 0.3176
## 29      tor 94 3586 428 812 115 675 0.3157
## 17      min 92 3543 379 774  86 745 0.3157
## 4       bal 96 3612 462 879 132 665 0.3152
## 21      phi 96 3585 371 837  90 704 0.3116
## 13      kca 92 3436 365 802  60 591 0.3113
## 16      mil 94 3544 369 828  90 683 0.3113
## 22      pit 93 3513 358 767  89 776 0.3094
## 23      sdn 96 3641 379 795  88 760 0.3088
## 24      sea 95 3618 373 795 115 788 0.3082
## 18      nya 95 3522 373 767  88 690 0.3064
## 19      nyn 91 3554 376 747  87 794 0.3032
## 6       cha 92 3444 345 785  89 700 0.3014
## 7       chn 93 3483 384 769 103 667 0.3014
## 30      was 95 3493 357 757  86 733 0.3003
## 12      hou 94 3444 351 732  90 871 0.2934
## 15      mia 93 3465 305 731  57 656 0.2920
```


These numbers are *very* close. 

#### Modeling the Expected Runs Matrix (REM)

In this case we have `107774` observations. However, not all of these innings were completed, due to walk-offs. By including these innings, we would be underestimating the expected run values, since those walk-off innings score fewer runs than they potentially could have. 


```{r, eval=FALSE}
walk.offs = ddply(subset(ds, outsInInning < 3, select = c("gameId", "inning", 
    "half")), ~gameId + inning + half, nrow)
walk.offs
```

```
##                             gameId inning   half V1
## 1   gid_2013_04_01_colmlb_milmlb_1     10 bottom  5
## 2   gid_2013_04_03_anamlb_cinmlb_1      9 bottom  3
## 3   gid_2013_04_03_balmlb_tbamlb_1      9 bottom  1
## 4   gid_2013_04_03_detmlb_minmlb_1      9 bottom  4
## 5   gid_2013_04_03_slnmlb_arimlb_1     16 bottom  3
## 6   gid_2013_04_06_chnmlb_atlmlb_1      9 bottom  3
## 7   gid_2013_04_06_kcamlb_phimlb_1      9 bottom  6
## 8   gid_2013_04_07_miamlb_nynmlb_1      9 bottom  4
## 9   gid_2013_04_07_seamlb_chamlb_1     10 bottom  2
## 10  gid_2013_04_12_chamlb_clemlb_1      9 bottom  5
## 11  gid_2013_04_12_detmlb_oakmlb_1     12 bottom  2
## 12  gid_2013_04_12_sfnmlb_chnmlb_1      9 bottom  5
## 13  gid_2013_04_13_houmlb_anamlb_1      9 bottom  5
## 14  gid_2013_04_13_phimlb_miamlb_1      9 bottom  4
## 15  gid_2013_04_13_tbamlb_bosmlb_1     10 bottom  3
## 16  gid_2013_04_14_lanmlb_arimlb_1      9 bottom  4
## 17  gid_2013_04_14_tormlb_kcamlb_1      9 bottom  3
## 18  gid_2013_04_15_tbamlb_bosmlb_1      9 bottom  3
## 19  gid_2013_04_16_nynmlb_colmlb_2     10 bottom  5
## 20  gid_2013_04_16_phimlb_cinmlb_1      9 bottom  4
## 21  gid_2013_04_17_sfnmlb_milmlb_1      9 bottom  5
## 22  gid_2013_04_18_tbamlb_balmlb_1     10 bottom  4
## 23  gid_2013_04_19_sdnmlb_sfnmlb_1      9 bottom  3
## 24  gid_2013_04_20_miamlb_cinmlb_1     13 bottom  4
## 25  gid_2013_04_21_detmlb_anamlb_1     13 bottom  1
## 26  gid_2013_04_22_arimlb_sfnmlb_1      9 bottom  3
## 27  gid_2013_04_22_chnmlb_cinmlb_1     13 bottom  6
## 28  gid_2013_04_22_tormlb_balmlb_1      9 bottom  6
## 29  gid_2013_04_23_texmlb_anamlb_1     11 bottom  2
## 30  gid_2013_04_24_atlmlb_colmlb_1     12 bottom  4
## 31  gid_2013_04_24_lanmlb_nynmlb_1     10 bottom  5
## 32  gid_2013_04_27_colmlb_arimlb_1     10 bottom  4
## 33  gid_2013_04_27_sfnmlb_sdnmlb_1     12 bottom  4
## 34  gid_2013_04_28_balmlb_oakmlb_1     10 bottom  3
## 35  gid_2013_04_29_anamlb_oakmlb_1     19 bottom  4
## 36  gid_2013_04_29_nynmlb_miamlb_1     15 bottom  5
## 37  gid_2013_04_30_nynmlb_miamlb_1      9 bottom  4
## 38  gid_2013_05_03_lanmlb_sfnmlb_1      9 bottom  1
## 39  gid_2013_05_03_minmlb_clemlb_1     10 bottom  3
## 40  gid_2013_05_04_lanmlb_sfnmlb_1     10 bottom  2
## 41  gid_2013_05_05_bosmlb_texmlb_1      9 bottom  5
## 42  gid_2013_05_05_chamlb_kcamlb_1     10 bottom  6
## 43  gid_2013_05_06_minmlb_bosmlb_1     11 bottom  5
## 44  gid_2013_05_07_atlmlb_cinmlb_1      9 bottom  4
## 45  gid_2013_05_07_chamlb_nynmlb_1     10 bottom  3
## 46  gid_2013_05_08_phimlb_sfnmlb_1     10 bottom  5
## 47  gid_2013_05_09_pitmlb_nynmlb_1      9 bottom  3
## 48  gid_2013_05_09_tormlb_tbamlb_1     10 bottom  6
## 49  gid_2013_05_11_sdnmlb_tbamlb_1      9 bottom  4
## 50  gid_2013_05_14_milmlb_pitmlb_1     12 bottom  1
## 51  gid_2013_05_17_houmlb_pitmlb_1      9 bottom  6
## 52  gid_2013_05_17_seamlb_clemlb_1     10 bottom  5
## 53  gid_2013_05_18_seamlb_clemlb_1      9 bottom  4
## 54  gid_2013_05_19_cinmlb_phimlb_1      9 bottom  3
## 55  gid_2013_05_20_seamlb_clemlb_1     10 bottom  3
## 56  gid_2013_05_21_arimlb_colmlb_1     10 bottom  4
## 57  gid_2013_05_21_minmlb_atlmlb_1     10 bottom  5
## 58  gid_2013_05_21_nyamlb_balmlb_1     10 bottom  1
## 59  gid_2013_05_21_wasmlb_sfnmlb_1     10 bottom  3
## 60  gid_2013_05_22_tbamlb_tormlb_1     10 bottom  5
## 61  gid_2013_05_24_miamlb_chamlb_1     11 bottom  5
## 62  gid_2013_05_25_colmlb_sfnmlb_1     10 bottom  3
## 63  gid_2013_05_25_miamlb_chamlb_1      9 bottom  2
## 64  gid_2013_05_26_balmlb_tormlb_1      9 bottom  7
## 65  gid_2013_05_26_clemlb_bosmlb_1      9 bottom  8
## 66  gid_2013_05_26_texmlb_seamlb_1     13 bottom  4
## 67  gid_2013_05_27_colmlb_houmlb_1     12 bottom  5
## 68  gid_2013_05_27_texmlb_arimlb_2      9 bottom  4
## 69  gid_2013_05_28_miamlb_tbamlb_1      9 bottom  5
## 70  gid_2013_05_28_nyamlb_nynmlb_1      9 bottom  3
## 71  gid_2013_05_29_seamlb_sdnmlb_1     10 bottom  4
## 72  gid_2013_05_30_detmlb_pitmlb_1     11 bottom  4
## 73  gid_2013_05_31_detmlb_balmlb_1      9 bottom  6
## 74  gid_2013_05_31_tormlb_sdnmlb_1     17 bottom  4
## 75  gid_2013_06_01_chamlb_oakmlb_1     10 bottom  6
## 76  gid_2013_06_01_lanmlb_colmlb_1     10 bottom  5
## 77  gid_2013_06_01_seamlb_minmlb_1      9 bottom  5
## 78  gid_2013_06_01_wasmlb_atlmlb_1     10 bottom  4
## 79  gid_2013_06_02_cinmlb_pitmlb_1     11 bottom  5
## 80  gid_2013_06_04_miamlb_phimlb_1     11 bottom  6
## 81  gid_2013_06_04_nynmlb_wasmlb_1      9 bottom  5
## 82  gid_2013_06_04_oakmlb_milmlb_1     10 bottom  4
## 83  gid_2013_06_04_pitmlb_atlmlb_1     10 bottom  4
## 84  gid_2013_06_06_texmlb_bosmlb_1      9 bottom  3
## 85  gid_2013_06_07_atlmlb_lanmlb_1     10 bottom  3
## 86  gid_2013_06_07_phimlb_milmlb_1      9 bottom  4
## 87  gid_2013_06_07_sdnmlb_colmlb_1      9 bottom  1
## 88  gid_2013_06_08_texmlb_tormlb_1     18 bottom  4
## 89  gid_2013_06_09_sdnmlb_colmlb_1     10 bottom  5
## 90  gid_2013_06_12_detmlb_kcamlb_1     10 bottom  4
## 91  gid_2013_06_13_bosmlb_balmlb_1     13 bottom  5
## 92  gid_2013_06_13_cinmlb_chnmlb_1     14 bottom  5
## 93  gid_2013_06_13_nyamlb_oakmlb_1     18 bottom  5
## 94  gid_2013_06_14_milmlb_cinmlb_1     10 bottom  2
## 95  gid_2013_06_14_wasmlb_clemlb_1      9 bottom  4
## 96  gid_2013_06_15_sfnmlb_atlmlb_1      9 bottom  6
## 97  gid_2013_06_16_chnmlb_nynmlb_1      9 bottom  5
## 98  gid_2013_06_17_nynmlb_atlmlb_1      9 bottom  3
## 99  gid_2013_06_17_wasmlb_phimlb_1      9 bottom  5
## 100 gid_2013_06_18_miamlb_arimlb_1      9 bottom  1
## 101 gid_2013_06_18_tbamlb_bosmlb_2      9 bottom  2
## 102 gid_2013_06_19_pitmlb_cinmlb_1     13 bottom  5
## 103 gid_2013_06_20_bosmlb_detmlb_1      9 bottom  2
## 104 gid_2013_06_20_milmlb_houmlb_1     10 bottom  4
## 105 gid_2013_06_21_balmlb_tormlb_1      9 bottom  5
## 106 gid_2013_06_22_cinmlb_arimlb_1      9 bottom  4
## 107 gid_2013_06_22_miamlb_sfnmlb_1     11 bottom  5
## 108 gid_2013_06_22_nynmlb_phimlb_1      9 bottom  1
## 109 gid_2013_06_23_oakmlb_seamlb_1     10 bottom  4
## 110 gid_2013_06_24_phimlb_sdnmlb_1     10 bottom  5
## 111 gid_2013_06_25_nynmlb_chamlb_1      9 bottom  5
## 112 gid_2013_06_25_texmlb_nyamlb_1      9 bottom  3
## 113 gid_2013_06_26_atlmlb_kcamlb_1     10 bottom  3
## 114 gid_2013_06_28_chnmlb_seamlb_1     10 bottom  5
## 115 gid_2013_06_29_detmlb_tbamlb_1     10 bottom  5
## 116 gid_2013_06_29_phimlb_lanmlb_1      9 bottom  4
## 117 gid_2013_06_29_sfnmlb_colmlb_1      9 bottom  4
## 118 gid_2013_06_30_milmlb_pitmlb_1     14 bottom  4
## 119 gid_2013_06_30_sdnmlb_miamlb_1      9 bottom  5
## 120 gid_2013_06_30_tormlb_bosmlb_1      9 bottom  4
## 121 gid_2013_07_01_arimlb_nynmlb_1     13 bottom  6
## 122 gid_2013_07_03_sdnmlb_bosmlb_1      9 bottom  1
## 123 gid_2013_07_03_sfnmlb_cinmlb_1     11 bottom  5
## 124 gid_2013_07_04_balmlb_chamlb_1      9 bottom  2
## 125 gid_2013_07_04_slnmlb_anamlb_1      9 bottom  7
## 126 gid_2013_07_05_balmlb_nyamlb_1      9 bottom  6
## 127 gid_2013_07_06_bosmlb_anamlb_1     11 bottom  3
## 128 gid_2013_07_06_miamlb_slnmlb_1      9 bottom  4
## 129 gid_2013_07_07_pitmlb_chnmlb_1     11 bottom  4
## 130 gid_2013_07_10_minmlb_tbamlb_1     13 bottom  5
## 131 gid_2013_07_12_nynmlb_pitmlb_1     11 bottom  5
## 132 gid_2013_07_13_chamlb_phimlb_2     13 bottom  4
## 133 gid_2013_07_13_wasmlb_miamlb_1     10 bottom  5
## 134 gid_2013_07_14_bosmlb_oakmlb_1     11 bottom  5
## 135 gid_2013_07_14_chamlb_phimlb_1     10 bottom  6
```


There were `135`, all of which occurred in the bottom of an inning after the 8th. Let's remove these half-innings


```{r, eval=FALSE}
ds.complete = subset(ds, outsInInning == 3)
```



These break down by state as follows:


```{r, eval=FALSE}
rmod1 = favstats(runsFuture ~ as.factor(startCode) + as.factor(startOuts), data = ds.complete)
rmod1
```

```
##     min Q1 median Q3 max    mean     sd     n missing
## 0.0   0  0      0  1  11 0.46451 0.9684 26387       0
## 1.0   0  0      0  1   9 0.83107 1.2900  6174       0
## 2.0   0  0      1  2  11 1.10547 1.2952  1555       0
## 3.0   0  0      1  2   8 1.35908 1.5844  1437       0
## 4.0   0  1      1  1   6 1.30114 1.1687   176       0
## 5.0   0  1      1  3  11 1.85536 1.6124   560       0
## 6.0   0  1      2  3   8 2.03887 1.4373   283       0
## 7.0   0  1      2  3   8 2.29825 1.8425   342       0
## 0.1   0  0      0  0   8 0.24674 0.6913 19036       0
## 1.1   0  0      0  1  10 0.51207 1.0186  7538       0
## 2.1   0  0      0  1   8 0.64541 1.0382  2713       0
## 3.1   0  0      0  1  10 0.87382 1.3232  2639       0
## 4.1   0  0      1  1   5 0.91889 0.9177   900       0
## 5.1   0  0      1  2   8 1.12511 1.2690  1143       0
## 6.1   0  0      1  2   8 1.39281 1.4076   723       0
## 7.1   0  0      1  2  10 1.56250 1.6198   944       0
## 0.2   0  0      0  0   5 0.09102 0.3990 15062       0
## 1.2   0  0      0  0   6 0.21255 0.6481  7711       0
## 2.2   0  0      0  0   6 0.31313 0.7048  3481       0
## 3.2   0  0      0  0   7 0.41143 0.9301  3308       0
## 4.2   0  0      0  1   5 0.36049 0.7107  1473       0
## 5.2   0  0      0  1   6 0.52917 1.0111  1680       0
## 6.2   0  0      0  0   7 0.55890 1.1104   798       0
## 7.2   0  0      0  1   7 0.76096 1.3026  1163       0
```


The number of complete innings is:


```{r, eval=FALSE}
N = nrow(unique(ds.complete[, c("gameId", "inning", "half")]))
N
```

```
## [1] 25332
```

```{r, eval=FALSE}
nrow(subset(ds.complete, startCode == 0 & startOuts == 0 & runsITD == 0))
```

```
## [1] 25332
```

```{r, eval=FALSE}
nrow(subset(ds.complete, endCode == 0 & endOuts == 3))
```

```
## [1] 25332
```


Thus, in the empirical model for $runsFuture$, the value of the state $(0,0)$ is:


```{r, eval=FALSE}
rmod1$mean[1]
```

```
## [1] 0.4645
```


Alternatively, consider a regression model for $runsFuture$ as a function of $startCode$ and $startOuts$ and their interaction:


```{r, eval=FALSE}
rmod2 = lm(runsFuture ~ as.factor(startCode) * as.factor(startOuts), data = ds.complete)
summary(rmod2)
```

```
## 
## Call:
## lm(formula = runsFuture ~ as.factor(startCode) * as.factor(startOuts), 
##     data = ds.complete)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -2.298 -0.465 -0.247 -0.091 10.535 
## 
## Coefficients:
##                                             Estimate Std. Error t value
## (Intercept)                                  0.46451    0.00568   81.78
## as.factor(startCode)1                        0.36656    0.01304   28.10
## as.factor(startCode)2                        0.64096    0.02408   26.62
## as.factor(startCode)3                        0.89457    0.02499   35.79
## as.factor(startCode)4                        0.83663    0.06978   11.99
## as.factor(startCode)5                        1.39085    0.03940   35.30
## as.factor(startCode)6                        1.57436    0.05514   28.55
## as.factor(startCode)7                        1.83374    0.05021   36.52
## as.factor(startOuts)1                       -0.21777    0.00877  -24.82
## as.factor(startOuts)2                       -0.37349    0.00942  -39.64
## as.factor(startCode)1:as.factor(startOuts)1 -0.10123    0.01811   -5.59
## as.factor(startCode)2:as.factor(startOuts)1 -0.24229    0.03063   -7.91
## as.factor(startCode)3:as.factor(startOuts)1 -0.26750    0.03150   -8.49
## as.factor(startCode)4:as.factor(startOuts)1 -0.16448    0.07655   -2.15
## as.factor(startCode)5:as.factor(startOuts)1 -0.51248    0.04839  -10.59
## as.factor(startCode)6:as.factor(startOuts)1 -0.42830    0.06529   -6.56
## as.factor(startCode)7:as.factor(startOuts)1 -0.51798    0.05889   -8.80
## as.factor(startCode)1:as.factor(startOuts)2 -0.24503    0.01836  -13.35
## as.factor(startCode)2:as.factor(startOuts)2 -0.41885    0.02968  -14.11
## as.factor(startCode)3:as.factor(startOuts)2 -0.57417    0.03064  -18.74
## as.factor(startCode)4:as.factor(startOuts)2 -0.56716    0.07419   -7.65
## as.factor(startCode)5:as.factor(startOuts)2 -0.95271    0.04600  -20.71
## as.factor(startCode)6:as.factor(startOuts)2 -1.10649    0.06453  -17.15
## as.factor(startCode)7:as.factor(startOuts)2 -1.16380    0.05753  -20.23
##                                             Pr(>|t|)    
## (Intercept)                                  < 2e-16 ***
## as.factor(startCode)1                        < 2e-16 ***
## as.factor(startCode)2                        < 2e-16 ***
## as.factor(startCode)3                        < 2e-16 ***
## as.factor(startCode)4                        < 2e-16 ***
## as.factor(startCode)5                        < 2e-16 ***
## as.factor(startCode)6                        < 2e-16 ***
## as.factor(startCode)7                        < 2e-16 ***
## as.factor(startOuts)1                        < 2e-16 ***
## as.factor(startOuts)2                        < 2e-16 ***
## as.factor(startCode)1:as.factor(startOuts)1  2.3e-08 ***
## as.factor(startCode)2:as.factor(startOuts)1  2.6e-15 ***
## as.factor(startCode)3:as.factor(startOuts)1  < 2e-16 ***
## as.factor(startCode)4:as.factor(startOuts)1    0.032 *  
## as.factor(startCode)5:as.factor(startOuts)1  < 2e-16 ***
## as.factor(startCode)6:as.factor(startOuts)1  5.4e-11 ***
## as.factor(startCode)7:as.factor(startOuts)1  < 2e-16 ***
## as.factor(startCode)1:as.factor(startOuts)2  < 2e-16 ***
## as.factor(startCode)2:as.factor(startOuts)2  < 2e-16 ***
## as.factor(startCode)3:as.factor(startOuts)2  < 2e-16 ***
## as.factor(startCode)4:as.factor(startOuts)2  2.1e-14 ***
## as.factor(startCode)5:as.factor(startOuts)2  < 2e-16 ***
## as.factor(startCode)6:as.factor(startOuts)2  < 2e-16 ***
## as.factor(startCode)7:as.factor(startOuts)2  < 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.923 on 107202 degrees of freedom
## Multiple R-squared:  0.119,  Adjusted R-squared:  0.119 
## F-statistic:  632 on 23 and 107202 DF,  p-value: <2e-16
```

```{r, eval=FALSE}
fit.rem = makeFun(rmod2)
```


We can use this model to recover a Run Expectancy Matrix, similar to [this one](http://www.baseballprospectus.com/sortable/index.php?cid=1091223) computed by Baseball Prospectus from 2012. 

> Note that our notation for the baseCode is different from theirs. 


```{r, eval=FALSE}
states = expand.grid(startCode = 0:7, startOuts = 0:2)
states = transform(states, runs = predict(rmod2, newdata = states))
rem = matrix(states$runs, ncol = 3, dimnames = list(0:7, 0:2))
rem
```

```
##        0      1       2
## 0 0.4645 0.2467 0.09102
## 1 0.8311 0.5121 0.21255
## 2 1.1055 0.6454 0.31313
## 3 1.3591 0.8738 0.41143
## 4 1.3011 0.9189 0.36049
## 5 1.8554 1.1251 0.52917
## 6 2.0389 1.3928 0.55890
## 7 2.2982 1.5625 0.76096
```


Compare these figures with the empirical estimates


```{r, eval=FALSE}
matrix(rmod1$mean, ncol = 3, dimnames = list(0:7, 0:2))
```

```
##        0      1       2
## 0 0.4645 0.2467 0.09102
## 1 0.8311 0.5121 0.21255
## 2 1.1055 0.6454 0.31313
## 3 1.3591 0.8738 0.41143
## 4 1.3011 0.9189 0.36049
## 5 1.8554 1.1251 0.52917
## 6 2.0389 1.3928 0.55890
## 7 2.2982 1.5625 0.76096
```


The coefficients are the same, but the regression framework gives us a principled way to address the error in these estimates. We can also visualize our model. 


```{r, eval=FALSE}
xyplot(jitter(runsFuture) ~ jitter(startCode), groups = startOuts, data = ds.complete, 
    alpha = 0.3, pch = 19, auto.key = list(columns = 3), xlab = "Base Code before Plate Appearance", 
    ylab = "Runs Following Plate Appearance")
palette = trellis.par.get("superpose.symbol")$col
ladd(panel.lines(row.names(rem), rem[, 1], col = palette[1], lwd = 3))
ladd(panel.lines(row.names(rem), rem[, 2], col = palette[2], lwd = 3))
ladd(panel.lines(row.names(rem), rem[, 3], col = palette[3], lwd = 3))
```


We note that in general, each higher $baseCode$ is associated with a larger number of expected $futureRuns$, holding the number of $outs$ constant. We can see this more clearly by looking simply at the model estimates. 


```{r, eval=FALSE}
xyplot(runs ~ startCode, groups = startOuts, data = states, type = c("p", "l"), 
    auto.key = list(columns = 3), xlab = "Base Code before Plate Appearance", 
    ylab = "Expected Runs Following Plate Appearance")
```



It is also instructive to examine the distribution of runs scored **on** (not $futureRuns$, but rather $runsOnPlay$) a particular plate appearance. 


```{r, eval=FALSE}
xyplot(jitter(runsOnPlay) ~ jitter(startCode), groups = startOuts, data = ds.complete, 
    auto.key = list(columns = 3), xlab = "Base Code before Plate Appearance", 
    ylab = "Runs Generated by Plate Appearance")
```


#### Conservation of Expected Runs

We employ the notion of **conservation of runs**. That is, every run gained by the offense is a run lost by the defense. Thus, our first task is to determine, for each play, how many *expected* runs were gained by the offensive team. The defensive team must have lost that same number of *expected* runs. Let $r_i$ be actual number of runs scored on the $i^{th}$ play, and $\rho(b,o)$ be the true expected value of the state $(b,o)$. Then we define 
$$
  \delta_i = \rho(b_{i+1},o_{i+1}) - \rho(b_i,o_i) + r_{i}
$$
to be the true number of expected runs gained on the $i^{th}$ play. We stress that this quantity is unknown, since we can only estimate the true expected value associated with each $(base, out)$ state. 

One of the nice features of this type of model is that in $n$ completed innings, the number of expected runs generated should be exactly equal to the number of runs scored. 

$$
  \sum_{j \in innings} \sum_{i \in plays} \delta_{i}^j = \sum_{j \in innings} \sum_{i \in plays} \rho^j(b_{i+1}, o_{i+1}) - \rho^j(b_{i}, o_{i}) + r_{i}^j 
$$
$$
  = \sum_{j \in innings} \rho (0, 3) - \rho (0,0) + \sum_{i \in plays} r_i^j = - n \cdot \rho(0,0) + \sum_{j \in innings} \sum_{i \in plays} r_i^j
$$
This leads us to the estimate that
$$
  \hat{\rho}(0,0) = \frac{1}{n} \sum_{j \in innings} \sum_{i \in plays} r_i^j
$$

If runs are conserved, then the sum of all of the $\delta_i$'s should be zero.


```{r, eval=FALSE}
ds = makeWAR(ds)
```

```
## ...Estimating Expected Runs...
```

```
## ...Estimating Fielding Runs Above Average...
```

```
## Loading required package: KernSmooth
```

```
## KernSmooth 2.23 loaded Copyright M. P. Wand 1997-2009
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
```

```
## ...Estimating Pitching Runs Above Average...
```

```
## ...Estimating Baserunning Runs Above Average...
```

```
## Loading required package: MASS
```

```
## Loading required package: stringr
```

```
## ...Estimating Batting Runs Above Average...
```

```{r, eval=FALSE}
ds.complete = subset(ds, outsInInning == 3)
sum(ds.complete$delta)
```

```
## [1] 16.06
```


Moreover, the total number of runs scored should match the product of the number of completed innings times $\hat{\rho}(0,0)$. 


```{r, eval=FALSE}
sum(ds.complete$runsOnPlay)
```

```
## [1] 11783
```

```r
N * fit.rem(0, 0)
```

```
##     1 
## 11767
```


Note that the runs are not equally distributed across innings. The first inning is by far the most favorable to the offense (positive expected runs created), while the 9th inning is most favorable to the defense (closer pitching). 


```{r, eval=FALSE}
require(plyr)
ddply(ds, ~inning, summarise, N = length(inning), G = length(unique(gameId)), 
    D = sum(delta, na.rm = TRUE))
```

```
##    inning     N    G          D
## 1       1 12096 1414  140.36844
## 2       2 11955 1414  -16.63156
## 3       3 11893 1414    9.36844
## 4       4 12042 1414  103.36844
## 5       5 12060 1414  111.36844
## 6       6 12081 1414  117.83295
## 7       7 12021 1412    8.69098
## 8       8 11850 1410 -109.91549
## 9       9  8934 1410 -180.96177
## 10     10  1267  150   23.95861
## 11     11   580   70   -7.78690
## 12     12   316   39  -16.93594
## 13     13   256   31   -4.45114
## 14     14   182   19   13.68642
## 15     15    91   10   -3.19916
## 16     16    62    8   -3.18540
## 17     17    35    5   -3.55407
## 18     18    31    4   -1.37831
## 19     19    14    2    0.23299
## 20     20     8    1    0.07098
```

